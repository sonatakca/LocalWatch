# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Node.js implementation of a LiveReload server that monitors files for changes and automatically refreshes web browsers. The project provides both a CLI tool and a programmatic API.

## Development Commands

### Build
```bash
npm run build
```
Compiles CoffeeScript files in the `lib/` directory to JavaScript using CoffeeScript 2.x compiler.

### Test
```bash
npm test
```
Runs the full test suite. This command builds the project first, cleans temporary test files, then runs Mocha v11 tests configured via `.mocharc.json`.

## Architecture

### Source Code Structure
- **CoffeeScript Source**: The main source code is written in CoffeeScript 2.x and located in `lib/*.coffee`
- **Compiled JavaScript**: Generated JavaScript files are in `lib/*.js` (these are built from the CoffeeScript files)
- **CLI Entry Point**: `bin/livereload.js` is a simple wrapper that requires and runs `lib/command.js`
- **Test Configuration**: `.mocharc.json` configures Mocha v11 with CoffeeScript support

### Core Components
- **`lib/livereload.coffee`**: Main LiveReload server implementation
  - `Server` class extends EventEmitter
  - Uses `chokidar` for file watching
  - Uses `ws` (WebSocket) library for browser communication
  - Implements LiveReload protocol version 7
  - Serves the `livereload.js` client script from the `livereload-js` npm package

- **`lib/command.coffee`**: CLI interface implementation
  - Parses command-line arguments using `opts` library
  - Configures and starts the LiveReload server
  - Handles multiple watch paths (comma-separated)

### Key Configuration Options
The server accepts extensive configuration through both API and CLI:
- `port`/`-p`: Server port (default: 35729)
- `host`/`-b`: Bind host (default: localhost)  
- `exts`/`-e`: File extensions to watch (replaces defaults)
- `extraExts`/`-ee`: Additional extensions (adds to defaults)
- `exclusions`/`-x`: Regex patterns to exclude
- `filesToReload`/`-f`: Specific filenames that trigger reload
- `usePolling`/`-u`: Use polling for network file systems
- `delay`/`-w`: Delay between detection and browser notification
- `originalPath`/`-op`: Proxy development URLs to local paths
- `debug`/`-d`: Enable debug output

### Protocol & Communication
- Implements LiveReload protocol v7 with WebSocket communication
- Supports CORS and CORP headers for cross-origin scenarios
- Handles browser handshaking and file change broadcasting
- Default extensions: html, css, js, png, gif, jpg, php, php5, py, rb, erb, coffee

## Testing

### CLI Argument Testing
The CLI argument parsing is tested using a special approach due to the `opts` library's use of global state:

- **`command.createServerFromArgs(testArgv)`**: Test helper function that allows testing CLI flag parsing
  - Temporarily replaces `process.argv` with test arguments
  - Clears the `opts` module from require cache to get a fresh instance
  - Uses shared parsing logic to create server instances for testing
  - Returns `{server, path, version}` object for assertions
  - Test servers use `noListen: true` so they don't actually start listening

- **Testing Pattern**: Tests verify that CLI flags correctly set server configuration options
  - Example: `createServerFromArgs(['--port', '8080'])` should set `server.config.port = 8080`
  - All CLI options have corresponding tests for both long and short forms
  - Tests don't call `server.close()` since test servers are never started

### CORS Option Behavior
The `--cors` option requires a value when provided:
- `--cors http://localhost:3000` → sets CORS to the specified origin
- `--cors` (without value) → **invalid** and will cause opts to show an error
- No `--cors` flag → CORS defaults to `false`

## Development Notes

- All source files are written in CoffeeScript 2.x (upgraded from 1.x for Mocha v11 compatibility)
- When making changes, modify the `.coffee` files, not the `.js` files
- Always run `npm run build` after making changes to CoffeeScript files
- CoffeeScript 2.x requires `super()` to be called before accessing `this` in constructors
- Tests use Mocha v11 with `.mocharc.json` configuration (replaced deprecated `test/mocha.opts`)
- The project maintains backward compatibility and focuses on core LiveReload functionality (200+ dependent packages)
- Contributions should keep commits small and include both Coffee and JS files